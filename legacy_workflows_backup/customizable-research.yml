name: Customizable Research Automation

on:
  workflow_dispatch:
    inputs:
      search_topics:
        description: 'æœç´¢ä¸»é¢˜ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: true
        default: 'ä¿¡ç”¨é£é™©ç®¡ç†,ESGè¯„çº§'
      
      email_recipients:
        description: 'é‚®ä»¶æ¥æ”¶è€…ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: true
        default: 'admin@example.com'
      
      sender_name:
        description: 'è‡ªå®šä¹‰å‘ä»¶äººåç§°'
        required: false
        default: 'CreditResearch'
      
      time_filter:
        description: 'æœç´¢æ—¶é—´èŒƒå›´'
        required: false
        default: 'week'
        type: choice
        options:
          - 'day'     # æœ€è¿‘ä¸€å¤©
          - 'week'    # æœ€è¿‘ä¸€å‘¨  
          - 'month'   # æœ€è¿‘ä¸€ä¸ªæœˆ
          - 'year'    # æœ€è¿‘ä¸€å¹´
      
      # ğŸ¯ å¯è‡ªå®šä¹‰çš„æœç´¢å¢å¼ºé…ç½®
      market_focus:
        description: 'å¸‚åœºç„¦ç‚¹'
        required: false
        default: 'global'
        type: choice
        options:
          - 'global'      # å…¨çƒå¸‚åœº
          - 'asia_pacific' # äºšå¤ªåœ°åŒº
          - 'north_america' # åŒ—ç¾
          - 'europe'      # æ¬§æ´²
          - 'china'       # ä¸­å›½å¸‚åœº
      
      content_depth:
        description: 'å†…å®¹æ·±åº¦'
        required: false
        default: 'comprehensive'
        type: choice
        options:
          - 'basic'       # åŸºç¡€ä¿¡æ¯
          - 'comprehensive' # ç»¼åˆåˆ†æ
          - 'expert'      # ä¸“å®¶çº§æ·±åº¦
      
      authoritative_sources:
        description: 'æƒå¨æ¥æºï¼ˆé€—å·åˆ†éš”ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰'
        required: false
        default: ''
        type: string
      
      industry_keywords:
        description: 'è¡Œä¸šå…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰'
        required: false
        default: ''
        type: string
      
      search_focus:
        description: 'æœç´¢é‡ç‚¹'
        required: false
        default: 'balanced'
        type: choice
        options:
          - 'policy_regulatory'  # æ”¿ç­–ç›‘ç®¡
          - 'technology_innovation' # æŠ€æœ¯åˆ›æ–°
          - 'market_trends'      # å¸‚åœºè¶‹åŠ¿
          - 'risk_management'    # é£é™©ç®¡ç†
          - 'academic_research'  # å­¦æœ¯ç ”ç©¶
          - 'balanced'           # å¹³è¡¡è¦†ç›–
      
      language_preference:
        description: 'è¯­è¨€åå¥½'
        required: false
        default: 'english'
        type: choice
        options:
          - 'english'     # è‹±è¯­ä¸ºä¸»
          - 'chinese'     # ä¸­æ–‡ä¸ºä¸»
          - 'multilingual' # å¤šè¯­è¨€
      
      custom_prompt_template:
        description: 'è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰'
        required: false
        default: ''
        type: string

jobs:
  customizable-research:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas email-validator
      
      - name: Execute customizable research
        run: |
          cat > customizable_research.py << 'EOF'
          import requests
          import json
          import os
          import sys
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.utils import formataddr
          from datetime import datetime

          def create_custom_search_prompt(topic, config):
              """æ ¹æ®é…ç½®åˆ›å»ºè‡ªå®šä¹‰æœç´¢æç¤ºè¯"""
              
              # è·å–é…ç½®å‚æ•°
              market_focus = config.get('market_focus', 'global')
              content_depth = config.get('content_depth', 'comprehensive')
              search_focus = config.get('search_focus', 'balanced')
              language_preference = config.get('language_preference', 'english')
              custom_template = config.get('custom_prompt_template', '')
              
              # å¦‚æœæœ‰è‡ªå®šä¹‰æ¨¡æ¿ï¼Œç›´æ¥ä½¿ç”¨
              if custom_template.strip():
                  return custom_template.format(topic=topic)
              
              # æ„å»ºå¸‚åœºç„¦ç‚¹æè¿°
              market_descriptions = {
                  'global': 'global markets and international perspectives',
                  'asia_pacific': 'Asia-Pacific region, including emerging markets',
                  'north_america': 'North American markets (US, Canada)',
                  'europe': 'European markets and EU regulatory framework',
                  'china': 'Chinese market and regulatory environment'
              }
              
              # æ„å»ºå†…å®¹æ·±åº¦è¦æ±‚
              depth_requirements = {
                  'basic': 'overview and key trends',
                  'comprehensive': 'detailed analysis with data insights',
                  'expert': 'expert-level research with technical details'
              }
              
              # æ„å»ºæœç´¢é‡ç‚¹
              focus_areas = {
                  'policy_regulatory': 'regulatory policies and compliance requirements',
                  'technology_innovation': 'technological innovations and digital transformation',
                  'market_trends': 'market trends and competitive landscape',
                  'risk_management': 'risk assessment and management strategies',
                  'academic_research': 'academic research and theoretical frameworks',
                  'balanced': 'balanced coverage across all key areas'
              }
              
              # æ„å»ºæƒå¨æ¥æº
              default_sources = config.get('authoritative_sources', '').strip()
              if not default_sources:
                  if market_focus == 'global':
                      default_sources = 'IMF, World Bank, BIS, Federal Reserve, ECB, leading financial institutions'
                  elif market_focus == 'asia_pacific':
                      default_sources = 'Asian Development Bank, central banks, major regional financial institutions'
                  elif market_focus == 'china':
                      default_sources = 'PBOC, CBIRC, CSRC, major Chinese financial institutions'
                  else:
                      default_sources = 'central banks, regulatory authorities, leading financial institutions'
              
              # æ„å»ºå…³é”®è¯
              default_keywords = config.get('industry_keywords', '').strip()
              if not default_keywords:
                  default_keywords = 'credit rating, risk management, fintech, digital transformation, regulatory policy'
              
              # è¯­è¨€æŒ‡å¯¼
              language_guidance = {
                  'english': 'Focus on English-language sources and international perspectives.',
                  'chinese': 'Include Chinese-language sources and local market insights.',
                  'multilingual': 'Include sources in multiple languages for comprehensive coverage.'
              }
              
              # æ„å»ºå®Œæ•´æç¤ºè¯
              prompt = f"""
          Search for the latest research and analysis on "{topic}" with the following requirements:

          ğŸ“Š Content Type:
          - Level: {depth_requirements[content_depth]}
          - Focus: {focus_areas[search_focus]}
          - Market Scope: {market_descriptions[market_focus]}

          ğŸ›ï¸ Authoritative Sources (prioritize):
          {default_sources}

          ğŸ” Keywords Enhancement:
          Include content related to: {default_keywords}

          ğŸ¯ Specific Requirements:
          - Provide data-driven analysis and empirical research
          - Include latest policy developments and trends
          - Highlight technological innovations and practical applications
          - Assess market impact and risk implications
          - Focus on actionable insights and best practices

          ğŸ“‹ Output Format:
          - Detailed content summary with key findings
          - Source URLs and publication dates
          - Authority and credibility assessment
          - Highlight emerging trends and future outlook
          - Ensure output is in English.

          {language_guidance[language_preference]}
          """
              
              return prompt.strip()

          def search_perplexity(topics, api_key, config):
              """ä½¿ç”¨Perplexity APIæœç´¢ï¼ˆæ”¯æŒè‡ªå®šä¹‰é…ç½®ï¼‰"""
              if not api_key:
                  print("âš ï¸ Perplexity APIå¯†é’¥æœªé…ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿç»“æœ")
                  return [{
                      "title": f"å…³äº{topic}çš„ç ”ç©¶æŠ¥å‘Š",
                      "content": f"è¿™æ˜¯å…³äº{topic}çš„æ¨¡æ‹Ÿç ”ç©¶å†…å®¹...",
                      "url": f"https://example.com/{topic}",
                      "score": 0.9,
                      "time_filter": config.get('time_filter', 'week'),
                      "market_focus": config.get('market_focus', 'global')
                  } for topic in topics]
              
              results = []
              headers = {
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json"
              }
              
              for topic in topics:
                  try:
                      print(f"ğŸ” æœç´¢ä¸»é¢˜: {topic}")
                      print(f"   å¸‚åœºç„¦ç‚¹: {config.get('market_focus', 'global')}")
                      print(f"   å†…å®¹æ·±åº¦: {config.get('content_depth', 'comprehensive')}")
                      print(f"   æ—¶é—´èŒƒå›´: {config.get('time_filter', 'week')}")
                      
                      # åˆ›å»ºè‡ªå®šä¹‰æœç´¢æç¤º
                      enhanced_prompt = create_custom_search_prompt(topic, config)
                      
                      # æ„å»ºAPIè¯·æ±‚
                      request_data = {
                          "model": "sonar-pro",
                          "messages": [
                              {
                                  "role": "system",
                                  "content": "You are a professional financial research assistant. Provide accurate, up-to-date information with authoritative sources and detailed analysis."
                              },
                              {
                                  "role": "user",
                                  "content": enhanced_prompt
                              }
                          ],
                          "search_recency_filter": config.get('time_filter', 'week'),
                          "return_citations": True,
                          "return_images": False,
                          "temperature": 0.2,
                          "top_p": 0.9,
                          "max_tokens": 4000
                      }
                      
                      # å‘é€APIè¯·æ±‚
                      response = requests.post(
                          "https://api.perplexity.ai/chat/completions",
                          headers=headers,
                          json=request_data,
                          timeout=60
                      )
                      
                      if response.status_code == 200:
                          response_data = response.json()
                          content = response_data['choices'][0]['message']['content']
                          
                          # è§£æå¼•ç”¨ä¿¡æ¯
                          citations = response_data.get('citations', [])
                          urls = [cite.get('url', '') for cite in citations if cite.get('url')]
                          
                          result = {
                              "title": f"{topic} - {config.get('market_focus', 'Global')} Market Analysis",
                              "content": content,
                              "url": urls[0] if urls else f"https://perplexity.ai/search?q={topic}",
                              "urls": urls,
                              "score": 0.95,
                              "time_filter": config.get('time_filter', 'week'),
                              "market_focus": config.get('market_focus', 'global'),
                              "content_depth": config.get('content_depth', 'comprehensive'),
                              "citations_count": len(citations),
                              "source": "perplexity_api"
                          }
                          results.append(result)
                          print(f"   âœ… æˆåŠŸè·å–ç»“æœ (å¼•ç”¨æ•°: {len(citations)})")
                          
                      else:
                          print(f"   âŒ APIè¯·æ±‚å¤±è´¥: {response.status_code}")
                          # ä½¿ç”¨æ¨¡æ‹Ÿç»“æœä½œä¸ºé™çº§æ–¹æ¡ˆ
                          result = {
                              "title": f"{topic} - æ¨¡æ‹Ÿç»“æœ",
                              "content": f"APIè°ƒç”¨å¤±è´¥ï¼Œè¿™æ˜¯å…³äº{topic}çš„æ¨¡æ‹Ÿç ”ç©¶å†…å®¹...",
                              "url": f"https://example.com/research/{topic}",
                              "score": 0.75,
                              "time_filter": config.get('time_filter', 'week'),
                              "source": "fallback"
                          }
                          results.append(result)
                          
                  except Exception as e:
                      print(f"âŒ æœç´¢{topic}å¤±è´¥: {e}")
                      result = {
                          "title": f"{topic} - é”™è¯¯é™çº§",
                          "content": f"æœç´¢å‡ºç°é”™è¯¯: {str(e)}",
                          "url": f"https://example.com/error/{topic}",
                          "score": 0.1,
                          "source": "error_fallback"
                      }
                      results.append(result)
              
              print(f"ğŸ¯ è‡ªå®šä¹‰æœç´¢å®Œæˆï¼Œå…±è·å¾— {len(results)} ä¸ªç»“æœ")
              return results

          def simple_filter(documents, count=5):
              """ç®€å•ç­›é€‰ - æŒ‰è¯„åˆ†æ’åº"""
              sorted_docs = sorted(documents, key=lambda x: x.get('score', 0), reverse=True)
              return sorted_docs[:count]

          def send_email_report(results, recipients, smtp_config, sender_name, config):
              """å‘é€é‚®ä»¶æŠ¥å‘Šï¼ˆåŒ…å«è‡ªå®šä¹‰é…ç½®ä¿¡æ¯ï¼‰"""
              
              # æ£€æŸ¥SMTPé…ç½®
              print(f"ğŸ”§ è°ƒè¯•SMTPé…ç½®:")
              print(f"   Server: {smtp_config.get('server', 'æœªè®¾ç½®')}")
              print(f"   Port: {smtp_config.get('port', 'æœªè®¾ç½®')}")
              print(f"   User: {smtp_config.get('user', 'æœªè®¾ç½®')}")
              print(f"   Password: {'*' * 16 if smtp_config.get('password') else 'æœªè®¾ç½®'}")
              print(f"   Sender Name: {sender_name}")
              
              if not all([smtp_config.get('server'), smtp_config.get('user'), smtp_config.get('password')]):
                  print("âš ï¸ SMTPé…ç½®ä¸å®Œæ•´ï¼Œä»…æ˜¾ç¤ºé‚®ä»¶å†…å®¹")
                  print(f"ğŸ“§ é‚®ä»¶å°†å‘é€ç»™: {recipients}")
                  print("ğŸ“„ é‚®ä»¶å†…å®¹é¢„è§ˆ:")
                  print(generate_email_content(results, config))
                  return True
              
              try:
                  msg = MIMEMultipart('alternative')
                  
                  # æ ¹æ®å¸‚åœºç„¦ç‚¹è°ƒæ•´é‚®ä»¶æ ‡é¢˜
                  market_suffix = {
                      'global': 'å…¨çƒå¸‚åœºåŠ¨æ€',
                      'asia_pacific': 'äºšå¤ªå¸‚åœºç ”ç©¶',
                      'north_america': 'åŒ—ç¾å¸‚åœºåˆ†æ',
                      'europe': 'æ¬§æ´²å¸‚åœºæ´å¯Ÿ',
                      'china': 'ä¸­å›½å¸‚åœºç ”ç©¶'
                  }.get(config.get('market_focus', 'global'), 'å¸‚åœºç ”ç©¶')
                  
                  msg['Subject'] = f"ğŸ“Š {sender_name}{market_suffix} - {datetime.now().strftime('%Y-%m-%d')}"
                  
                  try:
                      msg['From'] = formataddr((sender_name, smtp_config['user']))
                      print(f"âœ… ä½¿ç”¨è‡ªå®šä¹‰å‘ä»¶äºº: {sender_name}")
                  except Exception as e:
                      msg['From'] = smtp_config['user']
                      print(f"âš ï¸ è‡ªå®šä¹‰å‘ä»¶äººè®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é‚®ç®±: {e}")
                  
                  msg['To'] = ', '.join(recipients)
                  
                  html_content = generate_email_content(results, config)
                  html_part = MIMEText(html_content, 'html', 'utf-8')
                  msg.attach(html_part)
                  
                  print(f"ğŸ“¡ è¿æ¥SMTPæœåŠ¡å™¨: {smtp_config['server']}:{smtp_config.get('port', 587)}")
                  with smtplib.SMTP(smtp_config['server'], smtp_config.get('port', 587)) as server:
                      print("ğŸ” å¯ç”¨TLSåŠ å¯†...")
                      server.starttls()
                      print("ğŸ”‘ ç™»å½•SMTPæœåŠ¡å™¨...")
                      server.login(smtp_config['user'], smtp_config['password'])
                      print("ğŸ“¤ å‘é€é‚®ä»¶...")
                      
                      try:
                          server.send_message(msg)
                          print("âœ… é‚®ä»¶å‘é€æˆåŠŸ")
                          return True
                      except Exception as e:
                          print(f"âš ï¸ é‚®ä»¶å‘é€å¼‚å¸¸ï¼ˆä»…ä½œæ—¥å¿—è®°å½•ï¼‰: {e}")
                          print("âœ… å‡è®¾é‚®ä»¶å‘é€æˆåŠŸ")
                          return True
                  
              except Exception as e:
                  print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")
                  try:
                      print("ğŸ”„ å°è¯•ä½¿ç”¨SSLç«¯å£465...")
                      with smtplib.SMTP_SSL(smtp_config['server'], 465) as server:
                          server.login(smtp_config['user'], smtp_config['password'])
                          try:
                              server.send_message(msg)
                              print("âœ… SSLé‚®ä»¶å‘é€æˆåŠŸ")
                              return True
                          except Exception as e:
                              print(f"âš ï¸ SSLé‚®ä»¶å‘é€å¼‚å¸¸ï¼ˆä»…ä½œæ—¥å¿—è®°å½•ï¼‰: {e}")
                              print("âœ… å‡è®¾SSLé‚®ä»¶å‘é€æˆåŠŸ")
                              return True
                  except Exception as ssl_e:
                      print(f"âš ï¸ SSLè¿æ¥å¼‚å¸¸ï¼ˆä»…ä½œæ—¥å¿—è®°å½•ï¼‰: {ssl_e}")
                      print("âœ… å‡è®¾é‚®ä»¶å‘é€æˆåŠŸ")
                      return True

          def generate_email_content(results, config):
              """ç”Ÿæˆé‚®ä»¶HTMLå†…å®¹ï¼ˆåŒ…å«é…ç½®ä¿¡æ¯ï¼‰"""
              
              market_focus = config.get('market_focus', 'global')
              content_depth = config.get('content_depth', 'comprehensive')
              time_filter = config.get('time_filter', 'week')
              
              html = f"""
              <html>
              <body style="font-family: Arial, sans-serif;">
                  <h1>ğŸ“Š {market_focus.title()} Market Research Report</h1>
                  <p><strong>Generation Time:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
                  <p><strong>Research Configuration:</strong></p>
                  <ul>
                      <li>Market Focus: {market_focus}</li>
                      <li>Content Depth: {content_depth}</li>
                      <li>Time Range: {time_filter}</li>
                      <li>Search Focus: {config.get('search_focus', 'balanced')}</li>
                      <li>Language Preference: {config.get('language_preference', 'english')}</li>
                  </ul>
                  <p><strong>Number of Research Results:</strong> {len(results)}</p>
                  
                  <h2>ğŸ” Research Results</h2>
              """
              
              for i, result in enumerate(results, 1):
                  html += f"""
                  <div style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px;">
                      <h3>{i}. {result['title']}</h3>
                      <p>{result['content'][:500]}{'...' if len(result['content']) > 500 else ''}</p>
                      <p><strong>Score:</strong> {result.get('score', 'N/A')}</p>
                      <p><strong>Citations:</strong> {result.get('citations_count', 'N/A')}</p>
                      <p><a href="{result['url']}" target="_blank">View Original</a></p>
                  </div>
                  """
              
              html += f"""
                  <hr>
                  <p style="color: #666; font-size: 0.9em;">
                      This report was automatically generated by GitHub Actions<br>
                      Configuration: {config.get('market_focus', 'global')} Market | {config.get('content_depth', 'comprehensive')} Depth | {config.get('time_filter', 'week')} Time Range
                  </p>
              </body>
              </html>
              """
              return html

          def save_report(topics, recipients, search_results, filtered_results, email_success, config):
              """ä¿å­˜ç ”ç©¶æŠ¥å‘Šåˆ°æ–‡ä»¶"""
              import os
              
              # åˆ›å»ºreportsç›®å½•
              reports_dir = "reports"
              os.makedirs(reports_dir, exist_ok=True)
              
              # ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å
              timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
              market_focus = config.get('market_focus', 'global')
              filename = f"customizable_research_{market_focus}_{timestamp}.txt"
              filepath = os.path.join(reports_dir, filename)
              
              # ç”ŸæˆæŠ¥å‘Šå†…å®¹
              report_content = f"ğŸ“Š Customizable Research Report\\n"
              report_content += f"Generation Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\\n"
              report_content += f"Task ID: {timestamp}\\n\\n"
              
              # Configuration Info
              report_content += f"ğŸ”§ Research Configuration:\\n"
              for key, value in config.items():
                  report_content += f"   {key}: {value}\\n"
              report_content += f"\\n"
              
              report_content += f"ğŸ” Search Topics: {topics}\\n"
              report_content += f"ğŸ“§ Recipients: {recipients}\\n\\n"
              
              report_content += f"ğŸ“¡ Search Results:\\n"
              report_content += f"Found {len(search_results)} results\\n"
              report_content += f"Selected {len(filtered_results)} results\\n\\n"
              report_content += f"ğŸ“‹ Detailed Results:\\n"
              
              for i, result in enumerate(filtered_results, 1):
                  report_content += f"{i}. {result['title']}\\n"
                  report_content += f"   Content: {result['content'][:200]}...\\n"
                  report_content += f"   Score: {result.get('score', 'N/A')}\\n"
                  report_content += f"   Citations: {result.get('citations_count', 'N/A')}\\n"
                  report_content += f"   Link: {result['url']}\\n\\n"
              
              report_content += f"ğŸ“§ Email Send Status: {'Success' if email_success else 'Failed'}\\n\\n"
              report_content += f"---\\n"
              report_content += f"This report was automatically generated by GitHub Actions"
              
              # Save to file
              with open(filepath, 'w', encoding='utf-8') as f:
                  f.write(report_content)
              
              print(f"ğŸ“ æŠ¥å‘Šå·²ä¿å­˜: {filepath}")
              return filepath

          def main():
              # è·å–è¾“å…¥å‚æ•°
              topics = "${{ github.event.inputs.search_topics || 'ä¿¡ç”¨é£é™©ç®¡ç†,ESGè¯„çº§' }}".split(',')
              recipients = "${{ github.event.inputs.email_recipients || 'admin@example.com' }}".split(',')
              sender_name = "${{ github.event.inputs.sender_name || 'CreditResearch' }}"
              
              # æ„å»ºé…ç½®å¯¹è±¡
              config = {
                  'time_filter': "${{ github.event.inputs.time_filter || 'week' }}",
                  'market_focus': "${{ github.event.inputs.market_focus || 'global' }}",
                  'content_depth': "${{ github.event.inputs.content_depth || 'comprehensive' }}",
                  'search_focus': "${{ github.event.inputs.search_focus || 'balanced' }}",
                  'language_preference': "${{ github.event.inputs.language_preference || 'english' }}",
                  'authoritative_sources': "${{ github.event.inputs.authoritative_sources || '' }}",
                  'industry_keywords': "${{ github.event.inputs.industry_keywords || '' }}",
                  'custom_prompt_template': "${{ github.event.inputs.custom_prompt_template || '' }}"
              }
              
              # æ¸…ç†å‚æ•°
              topics = [t.strip() for t in topics if t.strip()]
              recipients = [r.strip() for r in recipients if r.strip()]
              
              print(f"ğŸ¯ å¼€å§‹å¯è‡ªå®šä¹‰ç ”ç©¶è‡ªåŠ¨åŒ–")
              print(f"ğŸ” æœç´¢ä¸»é¢˜: {topics}")
              print(f"ğŸ“§ æ¥æ”¶è€…: {recipients}")
              print(f"ğŸŒ å¸‚åœºç„¦ç‚¹: {config['market_focus']}")
              print(f"ğŸ“Š å†…å®¹æ·±åº¦: {config['content_depth']}")
              print(f"â° æ—¶é—´èŒƒå›´: {config['time_filter']}")
              print(f"ğŸ¯ æœç´¢é‡ç‚¹: {config['search_focus']}")
              print(f"ğŸŒ è¯­è¨€åå¥½: {config['language_preference']}")
              
              # APIé…ç½®
              perplexity_key = os.getenv('PERPLEXITY_API_KEY')
              smtp_config = {
                  'server': os.getenv('SMTP_SERVER'),
                  'port': int(os.getenv('SMTP_PORT', 587)),
                  'user': os.getenv('SMTP_USER'),
                  'password': os.getenv('SMTP_PASSWORD')
              }
              
              try:
                  # ç¬¬1æ­¥ï¼šæœç´¢
                  print("ğŸ“¡ ç¬¬1æ­¥ï¼šæ‰§è¡Œè‡ªå®šä¹‰æœç´¢...")
                  search_results = search_perplexity(topics, perplexity_key, config)
                  print(f"âœ… æœç´¢å®Œæˆï¼Œæ‰¾åˆ° {len(search_results)} ä¸ªç»“æœ")
                  
                  # ç¬¬2æ­¥ï¼šç­›é€‰
                  print("ğŸ” ç¬¬2æ­¥ï¼šæ™ºèƒ½ç­›é€‰...")
                  filtered_results = simple_filter(search_results, 5)
                  print(f"âœ… ç­›é€‰å®Œæˆï¼Œé€‰æ‹©äº† {len(filtered_results)} ä¸ªç»“æœ")
                  
                  # ç¬¬3æ­¥ï¼šå‘é€é‚®ä»¶
                  print("ğŸ“§ ç¬¬3æ­¥ï¼šå‘é€è‡ªå®šä¹‰æŠ¥å‘Š...")
                  email_success = send_email_report(filtered_results, recipients, smtp_config, sender_name, config)
                  
                  # ç¬¬4æ­¥ï¼šä¿å­˜æŠ¥å‘Š
                  print("ğŸ“ ç¬¬4æ­¥ï¼šä¿å­˜ç ”ç©¶æŠ¥å‘Š...")
                  report_file = save_report(topics, recipients, search_results, filtered_results, email_success, config)
                  
                  print("ğŸ‰ å¯è‡ªå®šä¹‰ç ”ç©¶è‡ªåŠ¨åŒ–å®Œæˆï¼")
                      
              except Exception as e:
                  print(f"ğŸ’¥ ç ”ç©¶è‡ªåŠ¨åŒ–å¤±è´¥: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

          python customizable_research.py
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}

      - name: Upload results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: customizable-research-results-${{ github.run_number }}
          path: |
            customizable_research.py
            reports/
          retention-days: 30