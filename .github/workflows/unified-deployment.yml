name: ğŸš€ ç»Ÿä¸€éƒ¨ç½²ç®¡ç†

on:
  workflow_dispatch:
    inputs:
      deployment_mode:
        description: 'éƒ¨ç½²æ¨¡å¼é€‰æ‹©'
        required: true
        default: 'health_check'
        type: choice
        options:
          - 'health_check'  # å¥åº·æ£€æŸ¥
          - 'api_call'      # APIè°ƒç”¨æµ‹è¯•
          - 'self_hosted'   # è‡ªæ‰˜ç®¡éƒ¨ç½²
          - 'docker'        # Dockeréƒ¨ç½²
          - 'full_deploy'   # å®Œæ•´éƒ¨ç½²æµç¨‹
      
      api_endpoint:
        description: 'APIç«¯ç‚¹URL (ç”¨äºhealth_checkå’Œapi_callæ¨¡å¼)'
        required: false
        default: 'http://localhost:8000'
        type: string
      
      docker_image:
        description: 'Dockeré•œåƒåç§°'
        required: false
        default: 'creditmonitor:latest'
        type: string
      
      test_topics:
        description: 'æµ‹è¯•æœç´¢ä¸»é¢˜'
        required: false
        default: 'ä¿¡ç”¨é£é™©ç®¡ç†'
        type: string

env:
  PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
  QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
  CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
  SMTP_PORT: ${{ secrets.SMTP_PORT }}
  SMTP_USER: ${{ secrets.SMTP_USER }}
  SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}

jobs:
  health-check:
    name: ğŸ” å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.inputs.deployment_mode == 'health_check' || github.event.inputs.deployment_mode == 'full_deploy' }}
    
    outputs:
      health_status: ${{ steps.check.outputs.status }}
      api_available: ${{ steps.check.outputs.api_available }}
      
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests urllib3
    
    - name: ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥
      id: check
      run: |
        python3 << 'EOF'
        import requests
        import os
        import sys
        from datetime import datetime
        
        def health_check():
            print("ğŸ” å¼€å§‹å¥åº·æ£€æŸ¥...")
            print("=" * 40)
            
            api_endpoint = "${{ github.event.inputs.api_endpoint || 'http://localhost:8000' }}"
            
            checks = {
                "api_connectivity": False,
                "model_status": False,
                "smtp_config": False,
                "api_keys": False
            }
            
            # 1. APIè¿æ¥æ£€æŸ¥
            try:
                print(f"ğŸ“¡ æ£€æŸ¥APIè¿æ¥: {api_endpoint}")
                response = requests.get(f"{api_endpoint}/health", timeout=10)
                if response.status_code == 200:
                    checks["api_connectivity"] = True
                    print("âœ… APIè¿æ¥æ­£å¸¸")
                else:
                    print(f"âš ï¸ APIè¿æ¥å¼‚å¸¸: {response.status_code}")
            except Exception as e:
                print(f"âŒ APIè¿æ¥å¤±è´¥: {e}")
            
            # 2. æ¨¡å‹çŠ¶æ€æ£€æŸ¥ (æœ¬åœ°)
            try:
                sys.path.append(os.path.join(os.getcwd(), 'oop'))
                from model_manager import get_model_status
                
                status = get_model_status()
                available_models = [k for k, v in status.items() if v["available"]]
                
                if available_models:
                    checks["model_status"] = True
                    print(f"âœ… å¯ç”¨æ¨¡å‹: {', '.join(available_models)}")
                else:
                    print("âŒ æ²¡æœ‰å¯ç”¨æ¨¡å‹")
                    
            except ImportError:
                print("âš ï¸ æ— æ³•æ£€æŸ¥æœ¬åœ°æ¨¡å‹çŠ¶æ€")
            except Exception as e:
                print(f"âŒ æ¨¡å‹çŠ¶æ€æ£€æŸ¥å¤±è´¥: {e}")
            
            # 3. SMTPé…ç½®æ£€æŸ¥
            smtp_vars = ['SMTP_SERVER', 'SMTP_USER', 'SMTP_PASSWORD']
            smtp_config = {var: os.getenv(var) for var in smtp_vars}
            
            if all(smtp_config.values()):
                checks["smtp_config"] = True
                print("âœ… SMTPé…ç½®å®Œæ•´")
            else:
                missing = [k for k, v in smtp_config.items() if not v]
                print(f"âš ï¸ SMTPé…ç½®ç¼ºå¤±: {', '.join(missing)}")
            
            # 4. APIå¯†é’¥æ£€æŸ¥
            api_keys = {
                'QWEN': os.getenv('QWEN_API_KEY'),
                'PERPLEXITY': os.getenv('PERPLEXITY_API_KEY'),
                'CLAUDE': os.getenv('CLAUDE_API_KEY'),
                'OPENAI': os.getenv('OPENAI_API_KEY')
            }
            
            available_keys = [k for k, v in api_keys.items() if v]
            if available_keys:
                checks["api_keys"] = True
                print(f"âœ… å¯ç”¨APIå¯†é’¥: {', '.join(available_keys)}")
            else:
                print("âŒ æ²¡æœ‰å¯ç”¨çš„APIå¯†é’¥")
            
            # æ€»ä½“è¯„ä¼°
            passed_checks = sum(checks.values())
            total_checks = len(checks)
            health_score = (passed_checks / total_checks) * 100
            
            print(f"\nğŸ“Š å¥åº·æ£€æŸ¥ç»“æœ:")
            print(f"é€šè¿‡æ£€æŸ¥: {passed_checks}/{total_checks}")
            print(f"å¥åº·è¯„åˆ†: {health_score:.1f}%")
            
            # è¾“å‡ºç»“æœ
            status = "healthy" if health_score >= 75 else "degraded" if health_score >= 50 else "unhealthy"
            
            print(f"HEALTH_STATUS={status}")
            print(f"HEALTH_SCORE={health_score}")
            print(f"API_AVAILABLE={checks['api_connectivity']}")
            
            # å†™å…¥GitHubè¾“å‡º
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"status={status}\n")
                f.write(f"score={health_score}\n")
                f.write(f"api_available={checks['api_connectivity']}\n")
            
            return status == "healthy"
        
        if __name__ == "__main__":
            success = health_check()
            if not success:
                print("âš ï¸ å¥åº·æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†ç»§ç»­æ‰§è¡Œ...")
        EOF

  api-call-test:
    name: ğŸ§ª APIè°ƒç”¨æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.deployment_mode == 'api_call' || github.event.inputs.deployment_mode == 'full_deploy' }}
    needs: [health-check]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests urllib3 asyncio aiofiles
    
    - name: ğŸ§ª æ‰§è¡ŒAPIæµ‹è¯•
      run: |
        python3 << 'EOF'
        import requests
        import json
        import os
        import sys
        from datetime import datetime
        
        def test_api_calls():
            print("ğŸ§ª å¼€å§‹APIè°ƒç”¨æµ‹è¯•...")
            print("=" * 40)
            
            api_endpoint = "${{ github.event.inputs.api_endpoint || 'http://localhost:8000' }}"
            test_topics = "${{ github.event.inputs.test_topics || 'ä¿¡ç”¨é£é™©ç®¡ç†' }}"
            
            tests = []
            
            # æµ‹è¯•1: åŸºç¡€å¥åº·æ£€æŸ¥
            try:
                response = requests.get(f"{api_endpoint}/health", timeout=10)
                tests.append({
                    "name": "å¥åº·æ£€æŸ¥",
                    "status": response.status_code == 200,
                    "response_time": response.elapsed.total_seconds(),
                    "details": response.json() if response.status_code == 200 else response.text
                })
            except Exception as e:
                tests.append({
                    "name": "å¥åº·æ£€æŸ¥", 
                    "status": False,
                    "error": str(e)
                })
            
            # æµ‹è¯•2: å‘é‡åŒ–API (å¦‚æœå¯ç”¨)
            try:
                embed_data = {
                    "texts": [f"æµ‹è¯•æ–‡æœ¬: {test_topics}"],
                    "model": "embedding"
                }
                response = requests.post(
                    f"{api_endpoint}/vector/embed", 
                    json=embed_data,
                    timeout=30
                )
                tests.append({
                    "name": "å‘é‡åŒ–API",
                    "status": response.status_code == 200,
                    "response_time": response.elapsed.total_seconds(),
                    "details": f"å‘é‡ç»´åº¦: {len(response.json().get('embeddings', [{}])[0]) if response.status_code == 200 else 'N/A'}"
                })
            except Exception as e:
                tests.append({
                    "name": "å‘é‡åŒ–API",
                    "status": False,
                    "error": str(e)
                })
            
            # æµ‹è¯•3: ç ”ç©¶API (å¦‚æœå¯ç”¨)
            try:
                research_data = {
                    "search_config": {
                        "topics": [test_topics],
                        "time_filter": "week",
                        "max_results": 5,
                        "source": "perplexity"
                    },
                    "filter_config": {
                        "documents": [],
                        "selection_count": 3,
                        "model": "llm"
                    },
                    "email_config": {
                        "to": ["test@example.com"],
                        "subject": "APIæµ‹è¯•",
                        "body": "è‡ªåŠ¨åŒ–æµ‹è¯•",
                        "body_type": "text"
                    }
                }
                response = requests.post(
                    f"{api_endpoint}/research/automated", 
                    json=research_data,
                    timeout=60
                )
                tests.append({
                    "name": "ç ”ç©¶API",
                    "status": response.status_code == 200,
                    "response_time": response.elapsed.total_seconds(),
                    "details": f"ä»»åŠ¡ID: {response.json().get('task_id', 'N/A') if response.status_code == 200 else response.text[:100]}"
                })
            except Exception as e:
                tests.append({
                    "name": "ç ”ç©¶API",
                    "status": False,
                    "error": str(e)
                })
            
            # ç»“æœæ±‡æ€»
            passed_tests = sum(1 for t in tests if t["status"])
            total_tests = len(tests)
            
            print(f"\nğŸ“‹ APIæµ‹è¯•ç»“æœ:")
            for test in tests:
                status_icon = "âœ…" if test["status"] else "âŒ"
                name = test["name"]
                if test["status"]:
                    time_info = f" ({test.get('response_time', 0):.2f}s)"
                    details = test.get('details', '')
                    print(f"{status_icon} {name}{time_info} - {details}")
                else:
                    error = test.get('error', 'æœªçŸ¥é”™è¯¯')
                    print(f"{status_icon} {name} - é”™è¯¯: {error}")
            
            print(f"\né€šè¿‡æµ‹è¯•: {passed_tests}/{total_tests}")
            success_rate = (passed_tests / total_tests) * 100
            print(f"æˆåŠŸç‡: {success_rate:.1f}%")
            
            return success_rate >= 50  # è‡³å°‘50%æµ‹è¯•é€šè¿‡æ‰ç®—æˆåŠŸ
        
        if __name__ == "__main__":
            success = test_api_calls()
            if not success:
                print("âš ï¸ APIæµ‹è¯•éƒ¨åˆ†å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ...")
        EOF

  self-hosted-deploy:
    name: ğŸ  è‡ªæ‰˜ç®¡éƒ¨ç½²
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event.inputs.deployment_mode == 'self_hosted' || github.event.inputs.deployment_mode == 'full_deploy' }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-server
        
    - name: ğŸ”§ é…ç½®Redis
      run: |
        sudo systemctl start redis-server
        redis-cli ping
        
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install fastapi uvicorn redis
        
    - name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç¯å¢ƒ
      run: |
        # å¦‚æœå­˜åœ¨ç”Ÿäº§æ‰“åŒ…è„šæœ¬ï¼Œä½¿ç”¨å®ƒ
        if [ -f package_production.py ]; then
          python package_production.py
          cd production_package
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        cat > .env << EOF
        PERPLEXITY_API_KEY=${{ secrets.PERPLEXITY_API_KEY }}
        QWEN_API_KEY=${{ secrets.QWEN_API_KEY }}
        CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        
        SMTP_SERVER=${{ secrets.SMTP_SERVER }}
        SMTP_PORT=${{ secrets.SMTP_PORT }}
        SMTP_USER=${{ secrets.SMTP_USER }}
        SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
        
        REDIS_URL=redis://localhost:6379
        VECTOR_DB_TYPE=local
        CHROMA_DB_HOST=localhost
        CHROMA_DB_PORT=8001
        EOF
        
    - name: ğŸš€ å¯åŠ¨æœåŠ¡
      run: |
        # å¯åŠ¨APIæœåŠ¡ (åå°è¿è¡Œ)
        if [ -d api ]; then
          cd api
          nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > api.log 2>&1 &
          sleep 10  # ç­‰å¾…æœåŠ¡å¯åŠ¨
        fi
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        curl -f http://localhost:8000/health || echo "APIæœåŠ¡å¯èƒ½æœªå¯åŠ¨"
        
    - name: ğŸ§ª éªŒè¯éƒ¨ç½²
      run: |
        python3 << 'EOF'
        import requests
        import time
        import sys
        
        def verify_deployment():
            print("ğŸ§ª éªŒè¯è‡ªæ‰˜ç®¡éƒ¨ç½²...")
            
            api_url = "http://localhost:8000"
            max_retries = 5
            
            for i in range(max_retries):
                try:
                    response = requests.get(f"{api_url}/health", timeout=10)
                    if response.status_code == 200:
                        print("âœ… è‡ªæ‰˜ç®¡APIéƒ¨ç½²æˆåŠŸ")
                        print(f"æœåŠ¡å“åº”: {response.json()}")
                        return True
                    else:
                        print(f"âš ï¸ å°è¯• {i+1}/{max_retries}: HTTP {response.status_code}")
                except Exception as e:
                    print(f"âš ï¸ å°è¯• {i+1}/{max_retries}: {e}")
                
                if i < max_retries - 1:
                    time.sleep(5)
            
            print("âŒ è‡ªæ‰˜ç®¡éƒ¨ç½²éªŒè¯å¤±è´¥")
            return False
        
        success = verify_deployment()
        if not success:
            print("æŸ¥çœ‹APIæ—¥å¿—:")
            try:
                with open("api/api.log", "r") as f:
                    print(f.read()[-1000:])  # æ˜¾ç¤ºæœ€å1000å­—ç¬¦
            except:
                print("æ— æ³•è¯»å–APIæ—¥å¿—")
        EOF

  docker-deploy:
    name: ğŸ³ Dockeréƒ¨ç½²
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ github.event.inputs.deployment_mode == 'docker' || github.event.inputs.deployment_mode == 'full_deploy' }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ³ æ„å»ºDockeré•œåƒ
      run: |
        # åˆ›å»ºç®€å•çš„Dockerfile (å¦‚æœä¸å­˜åœ¨)
        if [ ! -f Dockerfile ]; then
          cat > Dockerfile << 'EOF'
        FROM python:3.9-slim

        WORKDIR /app

        COPY requirements.txt .
        RUN pip install -r requirements.txt

        COPY . .

        EXPOSE 8000

        CMD ["uvicorn", "api.app.main:app", "--host", "0.0.0.0", "--port", "8000"]
        EOF
        fi
        
        # æ„å»ºé•œåƒ
        docker build -t ${{ github.event.inputs.docker_image || 'creditmonitor:latest' }} .
        
    - name: ğŸ§ª æµ‹è¯•Dockeré•œåƒ
      run: |
        # å¯åŠ¨å®¹å™¨ (åå°)
        docker run -d --name creditmonitor-test \
          -p 8000:8000 \
          -e QWEN_API_KEY="${{ secrets.QWEN_API_KEY }}" \
          -e PERPLEXITY_API_KEY="${{ secrets.PERPLEXITY_API_KEY }}" \
          ${{ github.event.inputs.docker_image || 'creditmonitor:latest' }}
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 15
        
        # æµ‹è¯•è¿æ¥
        curl -f http://localhost:8000/health || echo "DockeræœåŠ¡å¯èƒ½æœªå¯åŠ¨"
        
        # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
        docker logs creditmonitor-test
        
        # æ¸…ç†
        docker stop creditmonitor-test
        docker rm creditmonitor-test

  summary:
    name: ğŸ“Š éƒ¨ç½²æ‘˜è¦
    runs-on: ubuntu-latest
    if: always()
    needs: [health-check, api-call-test, self-hosted-deploy, docker-deploy]
    
    steps:
    - name: ğŸ“‹ ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
      run: |
        echo "## ğŸš€ ç»Ÿä¸€éƒ¨ç½²ç®¡ç†æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**éƒ¨ç½²æ¨¡å¼**: ${{ github.event.inputs.deployment_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "**APIç«¯ç‚¹**: ${{ github.event.inputs.api_endpoint }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.health-check.result }}" != "skipped" ]; then
          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "- âœ… **å¥åº·æ£€æŸ¥**: é€šè¿‡ (è¯„åˆ†: ${{ needs.health-check.outputs.score || 'æœªçŸ¥' }}%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **å¥åº·æ£€æŸ¥**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        if [ "${{ needs.api-call-test.result }}" != "skipped" ]; then
          if [ "${{ needs.api-call-test.result }}" = "success" ]; then
            echo "- âœ… **APIæµ‹è¯•**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **APIæµ‹è¯•**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        if [ "${{ needs.self-hosted-deploy.result }}" != "skipped" ]; then
          if [ "${{ needs.self-hosted-deploy.result }}" = "success" ]; then
            echo "- âœ… **è‡ªæ‰˜ç®¡éƒ¨ç½²**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **è‡ªæ‰˜ç®¡éƒ¨ç½²**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        if [ "${{ needs.docker-deploy.result }}" != "skipped" ]; then
          if [ "${{ needs.docker-deploy.result }}" = "success" ]; then
            echo "- âœ… **Dockeréƒ¨ç½²**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Dockeréƒ¨ç½²**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç‰¹è‰²åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” **å¤šæ¨¡å¼æ”¯æŒ**: å¥åº·æ£€æŸ¥/APIæµ‹è¯•/è‡ªæ‰˜ç®¡/Docker" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ§ª **å…¨é¢æµ‹è¯•**: APIè¿æ¥/æ¨¡å‹çŠ¶æ€/SMTPé…ç½®éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸš€ **ä¸€é”®éƒ¨ç½²**: ç»Ÿä¸€çš„éƒ¨ç½²ç®¡ç†ç•Œé¢" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: å®æ—¶çŠ¶æ€ç›‘æ§å’Œé”™è¯¯è¯Šæ–­" >> $GITHUB_STEP_SUMMARY