name: Verify GitHub Secrets Configuration

on:
  workflow_dispatch:
    inputs:
      run_full_test:
        description: 'è¿è¡Œå®Œæ•´APIæµ‹è¯•'
        required: false
        default: false
        type: boolean

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ” éªŒè¯GitHub Secretsé…ç½®
      env:
        DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        GITHUB_ACTIONS: true
      run: |
        echo "ðŸ”§ å¼€å§‹éªŒè¯GitHub Secretsé…ç½®..."
        python tests/verify_github_secrets.py
        
    - name: ðŸ§ª è¿è¡Œå®Œæ•´APIæµ‹è¯•
      if: ${{ inputs.run_full_test }}
      env:
        DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        echo "ðŸš€ è¿è¡Œå®Œæ•´APIè¿žé€šæ€§æµ‹è¯•..."
        python tests/test_api.py || echo "âš ï¸ APIæµ‹è¯•éœ€è¦è¿è¡Œä¸­çš„æœåŠ¡å™¨"
        
    - name: ðŸ¤– æµ‹è¯•ç»Ÿä¸€æ¨¡åž‹ç®¡ç†å™¨
      env:
        DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
      run: |
        echo "ðŸ§  æµ‹è¯•ç»Ÿä¸€æ¨¡åž‹ç®¡ç†å™¨..."
        python -c "
        import sys
        sys.path.append('.')
        try:
            from oop.model_manager import model_manager
            status = model_manager.get_model_status()
            print(f'âœ… æ¨¡åž‹ç®¡ç†å™¨æ­£å¸¸ - {len(status)} ä¸ªæ¨¡åž‹å·²æ³¨å†Œ')
            for alias, info in status.items():
                print(f'   â€¢ {alias}: {info.get(\"model_id\", \"unknown\")}')
        except Exception as e:
            print(f'âŒ æ¨¡åž‹ç®¡ç†å™¨é”™è¯¯: {e}')
            sys.exit(1)
        "
        
    - name: ðŸ“‹ ç”Ÿæˆé…ç½®æŠ¥å‘Š
      run: |
        echo "## ðŸ”§ GitHub Secrets é…ç½®éªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”‘ APIå¯†é’¥çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "| å¯†é’¥åç§° | çŠ¶æ€ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥DASHSCOPE_API_KEY
        if [ -n "${{ secrets.DASHSCOPE_API_KEY }}" ]; then
          echo "| DASHSCOPE_API_KEY | âœ… å·²é…ç½® | åƒé—®å®˜æ–¹APIå¯†é’¥ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| DASHSCOPE_API_KEY | âŒ æœªé…ç½® | åƒé—®å®˜æ–¹APIå¯†é’¥ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥PERPLEXITY_API_KEY
        if [ -n "${{ secrets.PERPLEXITY_API_KEY }}" ]; then
          echo "| PERPLEXITY_API_KEY | âœ… å·²é…ç½® | Perplexityæœç´¢API |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| PERPLEXITY_API_KEY | âŒ æœªé…ç½® | Perplexityæœç´¢API |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥QWEN_API_KEY
        if [ -n "${{ secrets.QWEN_API_KEY }}" ]; then
          echo "| QWEN_API_KEY | âœ… å·²é…ç½® | åƒé—®API (å…¼å®¹) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| QWEN_API_KEY | âšª æœªé…ç½® | åƒé—®API (å…¼å®¹) |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“§ é‚®ä»¶é…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "| é…ç½®é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥é‚®ä»¶é…ç½®
        if [ -n "${{ secrets.SMTP_SERVER }}" ]; then
          echo "| SMTP_SERVER | âœ… å·²é…ç½® |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| SMTP_SERVER | âšª æœªé…ç½® |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ secrets.SMTP_USER }}" ]; then
          echo "| SMTP_USER | âœ… å·²é…ç½® |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| SMTP_USER | âšª æœªé…ç½® |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ secrets.EMAIL_TO }}" ]; then
          echo "| EMAIL_TO | âœ… å·²é…ç½® |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| EMAIL_TO | âšª æœªé…ç½® |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ ¹æ®é…ç½®çŠ¶æ€ç»™å‡ºå»ºè®®
        if [ -n "${{ secrets.DASHSCOPE_API_KEY }}" ] && [ -n "${{ secrets.PERPLEXITY_API_KEY }}" ]; then
          echo "âœ… **APIå¯†é’¥é…ç½®å®Œæ•´ï¼** å¯ä»¥è¿è¡Œä»¥ä¸‹å·¥ä½œæµï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§  **Unified Training**: ChromaDBå‘é‡æ•°æ®åº“è®­ç»ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Simple Research Automation**: å¾ä¿¡ä¿¡æ¯è‡ªåŠ¨æœç´¢" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **è¯·å®ŒæˆAPIå¯†é’¥é…ç½®ï¼š**" >> $GITHUB_STEP_SUMMARY
          echo "1. è®¿é—® [APIå¯†é’¥é…ç½®æŒ‡å—](../docs/API_KEYS_SETUP_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          echo "2. åœ¨ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ å¯†é’¥" >> $GITHUB_STEP_SUMMARY
          echo "3. é‡æ–°è¿è¡Œæ­¤éªŒè¯å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
        fi